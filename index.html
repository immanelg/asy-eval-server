<!DOCTYPE html>
<html>
    <head>
        <script async defer src="https://buttons.github.io/buttons.js"></script>
        <script type="module">
        import { h, render, Component } from 'https://esm.sh/preact';

        class App extends Component {
            state = {
                code: "",

                outtype: "svg",
                svgText: "",
                pngUrl: "",
                pngBlob: null,

                loadingOutput: false, 
                nothingEverHappened: true, // no output, but isn't currently loading it either 

                status: null,
                errmsg: null,
            };
            resetdebouncer = () => {
                const { code } = this.state;

                window.location.hash = encodeURIComponent(code);
                localStorage.setItem("code", code);

                if (this.debounceTimer) {
                    clearTimeout(this.debounceTimer);
                }

                this.debounceTimer = setTimeout(() => {
                    this.sendEval();
                }, 1000);
            }
            contenttype = () => {
                const { outtype } = this.state;
                switch (outtype) {
                    case "svg": return "image/svg+xml";
                    case "png": return "image/png";
                    default: throw new Error("invalid type " + outtype);
                }
            }
            sendEval = async () => {
                const { code, outtype } = this.state;
                if (code.trim() === "") return;


                this.setState({ 
                    loadingOutput: true, 
                    nothingEverHappened: false, 
                    //output: '...' 
                    status: null,
                    errmsg: null,
                });

                try {
                    const response = await fetch('/eval', {
                        method: 'POST',
                        headers: {
                            Accept: this.contenttype(),
                        },
                        body: code
                    });
                    const blob = await response.blob();
                    if (response.headers.get("Content-Type") === "text/vnd.asy-compiler-error") {
                        const errmsg = await blob.text();
                        this.setState({status: "err", errmsg });
                        setTimeout(() => document.getElementById('compiler-error').scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'start'
                        }), 500);
                    } else {
                        this.setState({status: "ok"});
                        switch (outtype){
                            case "svg":
                                const svgText = await blob.text();
                                this.setState({ svgText });
                                break;
                            case "png":
                                const pngUrl = URL.createObjectURL(blob);
                                this.setState({ 
                                    pngUrl,
                                    pngBlob: blob
                                });
                                break;
                        }

                        setTimeout(() => document.getElementById('output').scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'start'
                        }), 500);
                    }
                } catch (error) {
                    this.setState({ output: `Request error: ${error.message}` });
                } finally {
                    this.setState({ loadingOutput: false });
                }
            }

            downloadOutput = () => {
               const { outtype, svgText, pngBlob } = this.state;

                const downloadFromBlob = (blob, name) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
                switch (outtype) {
                case "svg": 
                    downloadFromBlob(new Blob([svgText], { type: 'image/svg+xml' }), "asy.svg");
                    break;
                case "png": 
                    downloadFromBlob(pngBlob, "asy.png");
                    break;

                }
            }
            copyOutputToClipboard = () => {
                const { svgText, outtype, pngBlob } = this.state;

                switch (outtype) {
                    case "svg":
                        navigator.clipboard.writeText(svgText);
                        return;
                    case 'png':
                        if (navigator.clipboard && navigator.clipboard.write) {
                            const clipboardItem = new ClipboardItem({
                                [this.contenttype()]: pngBlob
                            });
                            navigator.clipboard.write([clipboardItem]);
                        } else {
                            alert('Your browser sucks');
                        }
                        return;
                }
            }

            autocode = `\
import three;
size(10cm, 0);
currentlight = light(diffuse = new pen[] {blue, green},
specular = new pen[] {black, white},
position = new triple[] {-Y+Z, X+Y});
draw(unitsphere, surfacepen=white);`
            autoidx = 0;
            autotyping = null; 
            startAutotype = () => {
                this.autotyping = setTimeout(() => {
                    this.autoidx = 0;
                    this.setState({code: ""});
                    const next = () => {
                        if (this.autoidx < this.autocode.length) {
                            this.setState(prevState => ({
                                code: prevState.code + this.autocode[this.autoidx],
                            }));
                            this.autoidx++;
                            const delay = 10;
                            this.autotyping = setTimeout(next, delay);
                        } else {
                            document.querySelector("#send-eval").click();
                        }
                    };
                    next();
                }, 0);
            }

            onHashChange = () => {
                const hash = window.location.hash.substring(1);
                if (hash !== "") {
                    const code = decodeURIComponent(hash);
                    this.setState({ code }, () => {
                        this.saveLocalStorage();
                        this.resetdebouncer();
                    });
                }
            }
            saveHash = () =>            { window.location.hash = encodeURIComponent(this.state.code); }
            saveLocalStorage = () =>    { localStorage.setItem("code", this.state.code); }

            componentDidMount = () => {
                const textarea = document.getElementById('editor');
                if (textarea) textarea.focus();

                let code;
                const hash = window.location.hash.substring(1);
                code = hash !== "" ? decodeURIComponent(hash) : localStorage.getItem("code") || "";
                this.setState({ code }, () => { 
                    this.saveHash(); 
                    this.saveLocalStorage(); 
                    this.resetdebouncer(); 
                });

                window.addEventListener('hashchange', this.onHashChange);

                return;

            }
            componentWillUnmount = () => {
                window.removeEventListener('hashchange', this.onHashChange);
                if (this.debounceTimer) clearTimeout(this.debounceTimer);
                if (this.autotyping) clearTimeout(this.autotyping);
            }

            renderOutput = () => {
                const { svgText, pngUrl, outtype, status } = this.state;

                switch (outtype) {
                case "svg": return h('div', {
                        id: 'output',
                        dangerouslySetInnerHTML: { __html: svgText },
                    });
                case "png": return h('img', {
                        id: 'output',
                        src: pngUrl,
                        alt: 'Asymptote output',
                        style: { maxWidth: '100%', height: 'auto' }
                    });
                }
            }
            render({}, { code, svgText, loadingOutput, nothingEverHappened, outtype, status, errmsg }) {
                return h('div', { }, [
                    h('h1', null, 'Asymptote Evaluator'),

                    h('a', {
                        class: 'github-button',
                        href: 'https://github.com/immanelg/asy-eval-server',
                        'data-color-scheme': 'no-preference: light; light: light; dark: dark;',
                        'data-size': 'large',
                        'data-show-count': 'true',
                        'aria-label': 'Star immanelg/asy-eval-server on GitHub'
                    }, 'Star'),

                    h('textarea', {
                        id: 'editor',
                        // placeholder: 'draw(circle((0,0), 50), blue+2pt);',
                        value: code,
                        class: status,
                        onInput: e => { 
                            if (this.autotyping) clearTimeout(this.autotyping);

                            this.setState({ code: e.target.value }, () => {
                                this.saveHash();
                                this.saveLocalStorage();
                                this.resetdebouncer();
                            });
                        },
                        onKeyDown: e => {
                            if (e.ctrlKey && e.key === 'Enter' && this.state.code.trim() !== "") this.sendEval()
                        },

                    }),

                    h('button', {
                        id: 'send-eval',
                        disabled: (code.trim() === "") || loadingOutput,
                        onClick: this.sendEval,
                    }, loadingOutput ? 'Evaluating...' : 'Evaluate'),
                    h('label', {
                        class: "typeswitch",
                    }, [
                        h('input', {
                            type: 'radio',
                            name: 'outtype',
                            checked: outtype == "svg",
                            onChange: () => { 
                                this.setState({ outtype: 'svg' }, () => this.sendEval())
                            }
                        }),
                        h("span", null, 'SVG'),
                    ]),
                    h('label', {
                        class: "typeswitch",
                    }, [
                        h('input', {
                            type: 'radio',
                            name: 'outtype',
                            checked: outtype == "png",
                            onChange: () => this.setState({ outtype: 'png' }, () => this.sendEval())
                        }),
                        h("span", null, 'PNG'),
                    ]),

                    !nothingEverHappened && !loadingOutput && !(status == "err") && [
                        h("button", {
                            class: "share",
                            onClick: e => this.downloadOutput()
                        }, "Save"),
                        h("button", {
                            class: "share",
                            onClick: e => this.copyOutputToClipboard(),
                        }, "Copy"),
                        /* h("button", {
                        onClick: e => navigator.share({
                            title: 'Asymptote Image',
                            text: `Code: ${code}`,
                            files: [
                                new File([new Blob([output], { type: 'image/svg+xml' })], 'asymptote-drawing.svg', { 
                                    type: 'image/svg+xml' 
                                })
                            ]
                        })
                    }, "Share"), */
                    ],
                    h('button', {
                        class: 'start-demo',
                        onClick: e => this.startAutotype(),
                    }, 'Demo!'),


                    !loadingOutput && status === "err" && [
                        h("p", null, "Compiler error:"),
                        h("pre", {
                        id: "compiler-error",
                    }, errmsg),
                    ],


                    !nothingEverHappened && !loadingOutput && !(status == "err") && h('div', {
                        id: 'output',
                        // dangerouslySetInnerHTML: { __html: this.renderOutput()},
                    }, this.renderOutput()),
                ]);
            }
        }

        render(h(App), document.getElementById("app"));
        </script>

        <style>
        body {
            box-sizing: border-box;

            font-family: sans-serif;

            margin: 40px auto;
            max-width: 800px;
            padding: 10px;
        }
        textarea#editor {
            margin: 30px auto;

            padding: 10px;

            resize: vertical;

            font-family: monospace;

            width: 100%;
            height: 400px;

            border: 4px solid #ddd;
            border-radius: 4px;

            &.err {
                border: 4px solid hsl(16, 83.25%, 31%);
            }
            &.ok {
                border: 4px solid hsl(133, 83.25%, 31%);
            }
        }
        textarea#editor:focus {
            outline: none;
        }
        button#send-eval {
            font-size: 16px;
            color: rgb(256, 256, 256);

            margin: auto 10px;
            padding: 10px 20px;

            border: none;
            border-radius: 4px;

            cursor: pointer;

            background-color: hsl(123, 35%, 35%);

            &:hover {
                background-color: hsl(123, 51%, 35%);
            }

            &:disabled {
                background-color: hsl(100, 0%, 50%);
            }
            &:disabled:hover {
                background-color: hsl(100, 0%, 50%);
                cursor: not-allowed;
            }
        }
        label.typeswitch {
            display: inline-block;

            font-size: 16px;
            background-color: hsl(199, 25%, 50%);

            color: rgb(255, 255, 255);

            margin: auto 10px;
            padding: 10px 20px;

            border: none;
            border-radius: 4px;

            cursor: pointer;

            &:hover {
                background-color: hsl(199, 40%, 50%);
            }
            & input[type="radio"] {
                margin-right: 6px;
            }

            & input[type="radio"]:checked + span {
                font-weight: bold;
            }
        }

        button.share {
            font-size: 16px;
            color: rgb(256, 256, 256);

            margin: auto 10px;
            padding: 10px 20px;

            border: none;
            border-radius: 4px;

            cursor: pointer;

            background-color: hsl(180, 35%, 35%);
        }
        button.start-demo {
            font-size: 16px;
            color: rgb(256, 256, 256);

            margin: auto 10px;
            padding: 10px 20px;

            border: none;
            border-radius: 4px;

            cursor: pointer;

            background-color: hsl(300, 35%, 35%);
        }
        #output {
            margin: 30px auto;
            padding: 50px;

            border: 4px solid #ddd;
            border-radius: 4px;
        }
        pre#compiler-error {
            margin: 30px auto;
            padding: 20px;

            width: 100%;

            border: 4px solid hsl(16, 83.25%, 31%);
            border-radius: 4px;
        }
        .hidden {
            display: none;
        }
        </style>
    </head>
    <body>
        <div id="app"></div>
    </body>
</html>
